#!/bin/bash
# A script for testing compilability of different configurations
# (c) 2004--2006 Martin Mares <mj@ucw.cz>

set -e

TEST=0

function try
{
	TEST=$(($TEST+1))
	TDIR=tests/$TEST
	mkdir $TDIR
	echo "### Test $TEST: $@ ###" | tee $TDIR/log

	(
		cd $TDIR
		if ! ../../configure $@ CC=gcc-3.4 >>log 2>&1 ; then
			echo "	CANNOT CONFIGURE"
			exit 1
		fi
		if ! make >>log 2>&1 ; then
			echo "	FAILED"
			exit 1
		fi
		echo "	PASSED"
	)
}

rm -rf tests
mkdir tests
if [ -n "$1" ] ; then
	try "$@"
else
	try free									# the free version
	try bare -CONFIG_INDEXER -CONFIG_SEARCH						# absolutely stripped version
	try bare CONFIG_ALLOW_ANY							# the bare version
	try debug/matcher-test								# bare + custom stats and matchers
	try centrum/cz ROLE=search1-x							# various Centrum.cz configurations
	try centrum/cz ROLE=indexer
	try centrum/cz ROLE=gather
	try centrum/cz ROLE=reap+watson
	try centrum/cz ROLE=all CONFIG_PARTMAP_IS_MMAP
	try centrum/pl ROLE=all
	try debug CONFIG_SHARED								# debugging configuration with shared libs
	try debug									# debugging configuration
fi
