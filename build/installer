#!/bin/sh
set -e
DEST=`eval echo $1`
shift
echo "Installing to $DEST"
if [ ! -d $DEST/cf ] ; then
	echo "Creating $DEST and the whole directory hierarchy under it."
	mkdir -p $DEST/{cf,db,index,log,tmp}
fi
echo "Installing binaries..."
rm -rf $DEST/{bin,lib}
mkdir -p $DEST/{bin,lib}
cp -aL run/bin/* $DEST/bin/
cp -aL run/lib/* $DEST/lib/
echo "Installing config files..."
for a in "$@" ; do
	if [ -f run/cf/$a ] ; then
		if [ ! -f $DEST/cf/$a ] ; then
			echo "cf/$a: new, installed"
			cp run/cf/$a $DEST/cf/$a
		elif [ $a == catalog-rules ] ; then
			echo "cf/$a: will be regenerated automatically"
		elif diff -u $DEST/cf/$a run/cf/$a ; then
			echo "cf/$a: no differences"
		else
			echo -n "cf/$a differs, replace it [Yn]? "
			read x
			if [ -z "$x" -o "$x" == "y" -o "$x" == "Y" ] ; then
				echo "cf/$a: replacing and keeping the old version as cf/$a.old"
				mv $DEST/cf/$a $DEST/cf/$a.old
				cp run/cf/$a $DEST/cf/$a
			else
				echo "cf/$a: installing the new version as cf/$a.dist"
				cp run/cf/$a $DEST/cf/$a.dist
			fi
		fi
	fi
done
echo "Done."
