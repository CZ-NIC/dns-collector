#!/bin/sh
set -e
DEST=`eval echo $1`
echo "Installing to $DEST"
if [ ! -d $DEST/cf ] ; then
	echo "Creating $DEST and the whole directory hierarchy under it."
	mkdir -p $DEST/{cf,db,index,log,tmp}
fi
echo "Installing binaries..."
rm -rf $DEST/{bin,lib}
mkdir -p $DEST/{bin,lib}
cp -aL run/bin/* $DEST/bin/
cp -aL run/lib/* $DEST/lib/
echo "Installing config files..."
for a in cf/* ; do
	if [ -f run/$a ] ; then
		if [ ! -f $DEST/$a ] ; then
			echo "$a: new, installed"
			cp run/$a $DEST/$a
		elif diff -u $DEST/$a run/$a ; then
			echo "$a: no differences"
		else
			echo -n "$a differs, replace it [Yn]? "
			read x
			if [ -z "$x" -o "$x" == "y" -o "$x" == "Y" ] ; then
				echo "$a: replacing and keeping the old version as $a.old"
				mv $DEST/$a $DEST/$a.old
				cp run/$a $DEST/$a
			else
				echo "$a: installing the new version as $a.dist"
				cp run/$a $DEST/$a.dist
			fi
		fi
	fi
done
echo "Done."
