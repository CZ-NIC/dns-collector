image: ubuntu:bionic

variables:
  # VERSION: "$CI_COMMIT_TAG"
  VERSION: "1.0"

stages:
  - build
  - test
  - packages

build:
  stage: build
  before_script:
    - apt update
    - apt -y install make gcc build-essential libknot-dev libtrace3-dev
  script:
    - make all
  artifacts:
    paths:
      - dns-collector

# test:
#   stage: test
#   before_script:
#     - apt update
#     - apt -y install make
#   script:
#     - make test

.package_ubuntu: &package-ubuntu
  stage: packages
  before_script:
    - apt update
    - apt -y install make gcc build-essential libknot-dev libtrace3-dev
  script:
    - make all
    - fpm -s dir -t deb -n $CI_PROJECT_NAME -v $VERSION --prefix /usr/bin dns-collector
  artifacts:
    paths:
      - $CI_PROJECT_NAME_$VERSION_amd64.deb

package_ubuntu_1804:
  <<: *package-ubuntu
  image: helb/fwd-ubuntu-bionic

package_ubuntu_1710:
  <<: *package-ubuntu
  image: alanfranz/fpm-within-docker:ubuntu-artful

package_ubuntu_1604:
  <<: *package-ubuntu
  image: alanfranz/fpm-within-docker:ubuntu-xenial
